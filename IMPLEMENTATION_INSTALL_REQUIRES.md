# PAK Implementation: Auto-Populate install_requires from requirements.txt

## Background

Currently, APKGs include both `setup.py` (for package structure) and `requirements.txt` (for dependencies), but these are disconnected. When PAR deploys an agent with `pip install -e .`, only the package structure is installed - **dependencies are NOT installed**.

This causes runtime failures when agent code imports third-party libraries:
```python
# core/langchain_util.py
from langchain_openai import ChatOpenAI  # ❌ ModuleNotFoundError
```

Even though `langchain-openai==0.3.28` is listed in requirements.txt, it's never installed into the venv because `pip install -e .` doesn't read requirements.txt.

## Problem Statement

**Current state:**
1. PAK generates `setup.py` with `install_requires=[]` (empty)
2. PAK includes `requirements.txt` in APKG
3. PAR runs `pip install -e .` which installs package structure only
4. Dependencies in requirements.txt are never installed
5. Agent fails with import errors at runtime

**Desired state:**
1. PAK generates `setup.py` with `install_requires=[...]` populated from requirements.txt
2. PAR runs `pip install -e .` which installs BOTH package structure AND dependencies
3. Single command, standard Python packaging
4. No separate requirements.txt installation needed

## Objective

Modify PAK's `_generate_setup_py()` to automatically populate `install_requires` from requirements.txt, making APKGs self-contained and properly installable with standard Python tools.

## Implementation Requirements

### 1. Add Requirements Parser

**Location:** New method in `AgentBuilder` class (builder.py)

**Purpose:** Parse requirements.txt and extract dependency specifications

**Implementation:**
```python
def _parse_requirements(self, req_file: Path) -> List[str]:
    """Parse requirements.txt and return list of dependency specifications.

    Args:
        req_file: Path to requirements.txt

    Returns:
        List of dependency strings suitable for install_requires

    Example:
        ['langchain-openai==0.3.28', 'fastapi>=0.100.0', 'requests']
    """
    if not req_file.exists():
        return []

    requirements = []

    try:
        with open(req_file, 'r') as f:
            for line in f:
                line = line.strip()

                # Skip empty lines and comments
                if not line or line.startswith('#'):
                    continue

                # Skip editable installs (-e .)
                if line.startswith('-e') or line.startswith('--editable'):
                    logger.warning(f"Skipping editable requirement: {line}")
                    continue

                # Skip index URLs and other pip options
                if line.startswith('-') or line.startswith('--'):
                    continue

                # Handle inline comments (e.g., "requests  # HTTP library")
                if '#' in line:
                    line = line.split('#')[0].strip()

                # Handle environment markers (e.g., "package; python_version>='3.8'")
                # Keep them as-is - setuptools supports them

                if line:
                    requirements.append(line)

        logger.info(f"Parsed {len(requirements)} dependencies from requirements.txt")
        return requirements

    except Exception as e:
        logger.error(f"Failed to parse requirements.txt: {e}")
        return []
```

### 2. Modify setup.py Template Generation

**Location:** `_generate_setup_py()` method in builder.py (lines 209-253)

**Changes needed:**

**Before:**
```python
def _generate_setup_py(self, packages: list) -> str:
    """Generate setup.py content from template."""
    # ... existing code ...

    setup_content = f'''#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.
"""

from setuptools import setup

setup(
    name="{self.manifest.name}",
    version="{self.manifest.metadata.version}",
    description="{self.manifest.description or "Agent package"}",
    packages={packages_str},
    package_dir={{"": "."}},
    install_requires=[],  # Dependencies handled by requirements.txt
    python_requires=">=3.9",
    include_package_data=True,
)
'''
    return setup_content
```

**After:**
```python
def _generate_setup_py(self, packages: list, install_requires: List[str] = None) -> str:
    """Generate setup.py content from template.

    Args:
        packages: List of package names to include
        install_requires: List of dependency specifications (optional)

    Returns:
        setup.py file content as string
    """
    if not self.manifest:
        raise BuildError("Manifest not loaded")

    # Ensure we have at least 'src' package
    if not packages:
        packages = ["src"]

    # Format packages list as Python list literal
    packages_str = "[\n"
    for pkg in packages:
        packages_str += f"        '{pkg}',\n"
    packages_str += "    ]"

    # Format install_requires list
    if install_requires:
        install_requires_str = "[\n"
        for req in install_requires:
            # Escape quotes in requirement strings
            req_escaped = req.replace('"', '\\"')
            install_requires_str += f"        '{req_escaped}',\n"
        install_requires_str += "    ]"
        install_requires_comment = f"  # Populated from requirements.txt ({len(install_requires)} dependencies)"
    else:
        install_requires_str = "[]"
        install_requires_comment = "  # No dependencies specified"

    # Generate setup.py content
    setup_content = f'''#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.

Discovered packages: {", ".join(packages) if packages else "none"}
Dependencies: {len(install_requires) if install_requires else 0} from requirements.txt
"""

from setuptools import setup

setup(
    name="{self.manifest.name}",
    version="{self.manifest.metadata.version}",
    description="{self.manifest.description or "Agent package"}",
    packages={packages_str},
    package_dir={{"": "."}},
    install_requires={install_requires_str},{install_requires_comment}
    python_requires=">=3.9",
    include_package_data=True,
)
'''
    return setup_content
```

### 3. Update _create_package_metadata() to Use Parser

**Location:** `_create_package_metadata()` method in builder.py (lines 255-291)

**Changes:**

```python
def _create_package_metadata(self, build_dir: Path):
    """Generate setup.py for agent package installation."""
    # Discover packages (always) and ensure package structure
    setup_file = build_dir / "setup.py"
    packages = self._discover_packages(build_dir)

    if not packages:
        packages = ["src"]  # Fallback to src directory
        print("Warning: No packages discovered, defaulting to 'src'")

    print(f"Discovered packages: {', '.join(packages)}")

    # Load optional PAK config
    config = self._load_pak_config()
    namespace_packages = set(
        config.get("namespace_packages", []) if isinstance(config, dict) else []
    )

    # Check if install_requires generation is enabled (opt-in)
    generate_install_requires = config.get("generate_install_requires", False)

    # Ensure package structure by creating missing __init__.py files
    created_inits = self._ensure_package_structure(build_dir, packages, namespace_packages)
    if created_inits:
        print(
            "⚠️  Created missing __init__.py files for: " + ", ".join(created_inits)
        )
        print("   Consider adding these files to your repository for proper packaging.")

    # If user provided setup.py, skip generation but we already ensured structure
    if setup_file.exists():
        print("Agent already has setup.py, skipping generation")
        return

    # Parse requirements.txt if generate_install_requires is enabled
    install_requires = None
    if generate_install_requires:
        req_file = build_dir / "requirements.txt"
        if req_file.exists():
            install_requires = self._parse_requirements(req_file)
            print(f"Parsed {len(install_requires)} dependencies from requirements.txt")
        else:
            print("Warning: generate_install_requires enabled but no requirements.txt found")

    # Generate setup.py content
    setup_content = self._generate_setup_py(packages, install_requires)

    # Write setup.py
    setup_file.write_text(setup_content)

    if install_requires:
        print(f"Generated setup.py with {len(install_requires)} dependencies")
    else:
        print("Generated setup.py for package installation")
```

### 4. Add pak.yaml Configuration Support

**Purpose:** Allow agents to opt-in to install_requires generation

**Configuration file:** `pak.yaml` in agent project root

**Example pak.yaml:**
```yaml
# Optional PAK build configuration

# Generate install_requires in setup.py from requirements.txt (default: false)
generate_install_requires: true

# Treat these packages as PEP 420 namespace packages (skip __init__.py)
namespace_packages:
  - some.namespace
```

**Loading logic:** Already implemented in `_load_pak_config()` (lines 293-307)

## Edge Cases to Handle

### Case 1: No requirements.txt File
**Scenario:** Agent has no dependencies
**Behavior:**
```python
install_requires = None  # or []
# setup.py will have install_requires=[]
```

### Case 2: requirements.txt with Comments and Blank Lines
**Input:**
```
# Core dependencies
langchain-openai==0.3.28

# HTTP client
requests>=2.28.0  # Used for API calls

# Optional, only on Python <3.11
typing-extensions; python_version<'3.11'
```

**Expected output:**
```python
install_requires=[
    'langchain-openai==0.3.28',
    'requests>=2.28.0',
    'typing-extensions; python_version<\'3.11\'',
]
```

### Case 3: requirements.txt with Editable Installs
**Input:**
```
-e git+https://github.com/user/repo.git@main#egg=package
requests
```

**Behavior:** Skip editable installs, include others
```python
install_requires=['requests']
# Warning logged: "Skipping editable requirement: -e git+..."
```

### Case 4: requirements.txt with pip Options
**Input:**
```
--index-url https://pypi.org/simple
--extra-index-url https://custom.pypi.org
requests
numpy
```

**Behavior:** Skip option lines, include packages
```python
install_requires=['requests', 'numpy']
```

### Case 5: requirements.txt with Environment Markers
**Input:**
```
dataclasses; python_version<'3.7'
pytest>=7.0; extra=='dev'
```

**Behavior:** Keep environment markers (setuptools supports them)
```python
install_requires=[
    'dataclasses; python_version<\'3.7\'',
    'pytest>=7.0; extra==\'dev\'',
]
```

### Case 6: Agent Already Has setup.py
**Behavior:** Don't overwrite it, skip generation entirely
```python
if setup_file.exists():
    logger.info("Agent already has setup.py, skipping generation")
    return
```

### Case 7: generate_install_requires=false (Default)
**Behavior:** Generate setup.py with `install_requires=[]` as before
**Backward compatible:** Existing agents work unchanged

### Case 8: Malformed requirements.txt
**Behavior:** Log error, return empty list, continue build
```python
except Exception as e:
    logger.error(f"Failed to parse requirements.txt: {e}")
    return []
```

## Testing Requirements

### Unit Tests

**File:** `tests/test_builder.py` or new `tests/test_requirements_parsing.py`

**Test cases:**

1. **test_parse_requirements_basic** - Simple requirements
```python
def test_parse_requirements_basic(tmp_path):
    """Test parsing basic requirements.txt."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("""
langchain-openai==0.3.28
requests>=2.28.0
fastapi
""")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 3
    assert "langchain-openai==0.3.28" in reqs
    assert "requests>=2.28.0" in reqs
    assert "fastapi" in reqs
```

2. **test_parse_requirements_with_comments** - Handle comments
```python
def test_parse_requirements_with_comments(tmp_path):
    """Test parsing requirements with comments."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("""
# Core dependencies
langchain-openai==0.3.28

# HTTP client
requests>=2.28.0  # Used for API calls
""")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 2
    assert "langchain-openai==0.3.28" in reqs
    assert "requests>=2.28.0" in reqs
```

3. **test_parse_requirements_skip_editable** - Skip -e flags
```python
def test_parse_requirements_skip_editable(tmp_path):
    """Test skipping editable installs."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("""
-e git+https://github.com/user/repo.git
requests
--editable .
numpy
""")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 2
    assert "requests" in reqs
    assert "numpy" in reqs
```

4. **test_parse_requirements_skip_pip_options** - Skip --index-url etc
```python
def test_parse_requirements_skip_pip_options(tmp_path):
    """Test skipping pip option lines."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("""
--index-url https://pypi.org/simple
requests
--extra-index-url https://custom.pypi.org
numpy
""")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 2
    assert "requests" in reqs
    assert "numpy" in reqs
```

5. **test_parse_requirements_environment_markers** - Keep markers
```python
def test_parse_requirements_environment_markers(tmp_path):
    """Test preserving environment markers."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("""
typing-extensions; python_version<'3.11'
dataclasses; python_version<'3.7'
""")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 2
    assert "typing-extensions; python_version<'3.11'" in reqs
    assert "dataclasses; python_version<'3.7'" in reqs
```

6. **test_parse_requirements_empty_file** - Handle empty file
```python
def test_parse_requirements_empty_file(tmp_path):
    """Test parsing empty requirements.txt."""
    req_file = tmp_path / "requirements.txt"
    req_file.write_text("")

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 0
```

7. **test_parse_requirements_no_file** - Handle missing file
```python
def test_parse_requirements_no_file(tmp_path):
    """Test handling missing requirements.txt."""
    req_file = tmp_path / "requirements.txt"

    builder = AgentBuilder(tmp_path)
    reqs = builder._parse_requirements(req_file)

    assert len(reqs) == 0
```

8. **test_generate_setup_py_with_install_requires** - Template generation
```python
def test_generate_setup_py_with_install_requires(tmp_path):
    """Test setup.py generation with install_requires."""
    # Create minimal manifest
    manifest = AgentManifest(
        name="test-agent",
        metadata={"version": "1.0.0"},
        description="Test agent"
    )

    builder = AgentBuilder(tmp_path)
    builder.manifest = manifest

    packages = ["src", "core"]
    install_requires = ["requests>=2.28.0", "numpy"]

    setup_content = builder._generate_setup_py(packages, install_requires)

    # Verify content
    assert "name=\"test-agent\"" in setup_content
    assert "'src'," in setup_content
    assert "'core'," in setup_content
    assert "'requests>=2.28.0'," in setup_content
    assert "'numpy'," in setup_content
    assert "install_requires=" in setup_content
```

9. **test_build_with_generate_install_requires** - Full integration
```python
def test_build_with_generate_install_requires(tmp_path):
    """Test building APKG with generate_install_requires enabled."""
    # Create test agent structure
    agent_dir = create_test_agent(tmp_path, structure="vivid-commenter")

    # Create pak.yaml with generate_install_requires
    pak_config = agent_dir / "pak.yaml"
    pak_config.write_text("generate_install_requires: true\n")

    # Create requirements.txt
    req_file = agent_dir / "requirements.txt"
    req_file.write_text("requests>=2.28.0\nnumpy\n")

    # Build APKG
    builder = AgentBuilder(agent_dir)
    apkg_path = builder.build(tmp_path / "dist")

    # Extract and verify
    extract_dir = tmp_path / "extracted"
    extract_apkg(apkg_path, extract_dir)

    setup_path = extract_dir / "setup.py"
    assert setup_path.exists()

    content = setup_path.read_text()
    assert "'requests>=2.28.0'," in content
    assert "'numpy'," in content
```

10. **test_build_without_generate_install_requires** - Backward compatibility
```python
def test_build_without_generate_install_requires(tmp_path):
    """Test that default behavior doesn't populate install_requires."""
    agent_dir = create_test_agent(tmp_path)

    # Build APKG (no pak.yaml, defaults to generate_install_requires=false)
    builder = AgentBuilder(agent_dir)
    apkg_path = builder.build(tmp_path / "dist")

    # Extract and verify
    extract_dir = tmp_path / "extracted"
    extract_apkg(apkg_path, extract_dir)

    setup_path = extract_dir / "setup.py"
    content = setup_path.read_text()

    # Should have empty install_requires
    assert "install_requires=[]" in content
```

## Validation After Implementation

### 1. Build Test Agent with Dependencies

```bash
cd /path/to/test-agent

# Create pak.yaml
cat > pak.yaml <<EOF
generate_install_requires: true
EOF

# Build APKG
pixell build

# Extract and inspect
unzip -q test-agent-1.0.0.apkg -d /tmp/test-apkg
cat /tmp/test-apkg/setup.py
```

**Expected output in setup.py:**
```python
setup(
    name="test-agent",
    version="1.0.0",
    packages=['src', 'core'],
    install_requires=[
        'langchain-openai==0.3.28',
        'requests>=2.28.0',
        # ... all from requirements.txt
    ],
)
```

### 2. Test Installation in Clean venv

```bash
# Create fresh venv
python3 -m venv /tmp/test-venv
source /tmp/test-venv/bin/activate

# Install agent from extracted APKG
cd /tmp/test-apkg
pip install -e .

# Verify dependencies installed
pip list | grep langchain-openai
pip list | grep requests

# Test imports
python -c "from langchain_openai import ChatOpenAI; print('OK')"
python -c "import core.langchain_util; print('OK')"
```

**Expected:** All imports succeed, no ModuleNotFoundError

### 3. Deploy to PAR and Test Runtime

```bash
# Deploy agent with fresh APKG
pixell deploy test-agent --version 1.0.0 --force

# Check deployment logs
aws ecs execute-command --cluster pixell-runtime-cluster \
  --task <task-id> \
  --container runtime \
  --command "/bin/bash" \
  --interactive

# Inside container, check venv
source /var/run/pixell/venvs/test-agent-1.0.0/bin/activate
pip list | grep langchain-openai  # Should be installed
python -c "import langchain_openai; print('OK')"  # Should work

# Test agent invocation
curl -X POST http://localhost:8080/agents/test-agent/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "hello"}'
```

**Expected:**
- Dependencies installed in venv
- Imports succeed
- Agent responds with real AI response (not mock)

### 4. Verify Backward Compatibility

```bash
# Build agent WITHOUT pak.yaml (defaults to generate_install_requires=false)
cd /path/to/old-agent
pixell build

# Extract and check setup.py
unzip -q old-agent-1.0.0.apkg -d /tmp/old-apkg
cat /tmp/old-apkg/setup.py
```

**Expected:** `install_requires=[]` (empty, backward compatible)

### 5. Check Build Output Messages

```bash
pixell build
```

**Expected output:**
```
Building agent from /path/to/agent...
Copying src: /path/src -> /tmp/build/src
Discovered packages: ['src', 'core', 'app']
Parsed 5 dependencies from requirements.txt
Generated setup.py with 5 dependencies

SUCCESS: Build successful!
  [Package] test-agent-1.0.0.apkg
  [Dependencies] 5 from requirements.txt
```

### 6. Validate setup.py Syntax

```bash
cd /tmp/test-apkg
python -c "exec(open('setup.py').read())"  # Should not raise
python setup.py --name  # Should print agent name
python setup.py --version  # Should print version
```

## Integration with PAR

### What Changes in PAR?

**Short answer:** Nothing required, but can be optimized later.

**Current PAR behavior (loader.py:452-483):**
```python
# Install agent package
pip install -e .

# If setup.py has install_requires populated, pip will install them automatically
# No separate requirements.txt installation needed
```

**Optional PAR optimization (future):**
```python
# Check if setup.py has install_requires populated
# If yes: skip requirements.txt installation
# If no: fall back to pip install -r requirements.txt
```

### Deployment Flow After Implementation

1. **Build:** PAK generates setup.py with install_requires from requirements.txt
2. **Package:** APKG contains setup.py with dependencies
3. **Deploy:** PAR runs `pip install -e .`
4. **Install:** pip installs both package structure AND dependencies (single command)
5. **Runtime:** All imports work, agent functions correctly

## Success Criteria

- ✅ PAK parses requirements.txt correctly (handles comments, markers, pip options)
- ✅ setup.py generated with populated install_requires when enabled
- ✅ `pip install -e .` installs both package and dependencies
- ✅ All unit tests pass
- ✅ Integration test with real agent succeeds
- ✅ Backward compatible (default: install_requires=[])
- ✅ Agent deploys and runs without import errors
- ✅ Build output shows dependency count

## Files to Modify

1. `/Users/syum/dev/pixell-agent-kit/pixell/core/builder.py`
   - Add `_parse_requirements()` method
   - Modify `_generate_setup_py()` signature and template
   - Modify `_create_package_metadata()` to use parser

2. `/Users/syum/dev/pixell-agent-kit/tests/test_builder.py`
   - Add unit tests for requirements parsing
   - Add integration tests for setup.py generation
   - Add backward compatibility tests

## Implementation Order

1. **Phase 1:** Implement `_parse_requirements()` with edge case handling
2. **Phase 2:** Add unit tests for requirements parsing
3. **Phase 3:** Modify `_generate_setup_py()` to accept install_requires parameter
4. **Phase 4:** Update `_create_package_metadata()` to use parser (opt-in via pak.yaml)
5. **Phase 5:** Add integration tests
6. **Phase 6:** Test with vivid-commenter agent
7. **Phase 7:** Validate deployment to PAR

## Security Considerations

### Code Injection Risk
**Concern:** Malicious requirements.txt could inject code during setup.py generation

**Mitigation:**
- Don't use `eval()` or `exec()` on requirements.txt content
- Escape quotes in requirement strings when generating setup.py
- requirements.txt is read as plain text, parsed line-by-line
- Generated setup.py uses string literals (no code execution)

### Dependency Confusion Attacks
**Concern:** Malicious package names in requirements.txt

**Mitigation:**
- PAK doesn't resolve or install packages (only parses text)
- pip handles installation with standard security measures
- Use CodeArtifact/private PyPI for enterprise deployments

## Example Generated setup.py

### With generate_install_requires=true

```python
#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.

Discovered packages: src, core, app, app.v1
Dependencies: 5 from requirements.txt
"""

from setuptools import setup

setup(
    name="vivid-commenter",
    version="1.0.1",
    description="AI-powered Reddit commenter for marketing automation",
    packages=[
        'src',
        'core',
        'app',
        'app.v1',
    ],
    package_dir={"": "."},
    install_requires=[
        'langchain-openai==0.3.28',
        'langchain-core',
        'fastapi>=0.100.0',
        'requests>=2.28.0',
        'structlog',
    ],  # Populated from requirements.txt (5 dependencies)
    python_requires=">=3.9",
    include_package_data=True,
)
```

### With generate_install_requires=false (default)

```python
#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.

Discovered packages: src, core, app, app.v1
Dependencies: 0 from requirements.txt
"""

from setuptools import setup

setup(
    name="vivid-commenter",
    version="1.0.1",
    description="AI-powered Reddit commenter for marketing automation",
    packages=[
        'src',
        'core',
        'app',
        'app.v1',
    ],
    package_dir={"": "."},
    install_requires=[],  # No dependencies specified
    python_requires=">=3.9",
    include_package_data=True,
)
```

## Notes

- Keep requirements parsing simple and robust
- Log warnings for skipped/malformed entries
- Don't validate package names (pip will do that)
- Environment markers are valid in install_requires
- Opt-in via pak.yaml prevents breaking existing agents
- Can be used with or without separate requirements.txt installation
- Future: Support reading from pyproject.toml as alternative

## Migration Path for Existing Agents

### For New Agents
Add to pak.yaml:
```yaml
generate_install_requires: true
```

### For Existing Agents
**Option 1:** Keep current behavior (no changes needed)
**Option 2:** Opt-in by adding pak.yaml with `generate_install_requires: true`

### For vivid-commenter (Immediate Fix)
1. Add pak.yaml with `generate_install_requires: true`
2. Rebuild APKG: `pixell build`
3. Redeploy: `pixell deploy vivid-commenter --version 1.0.1 --force`
4. Verify: Chat should work without mock responses
