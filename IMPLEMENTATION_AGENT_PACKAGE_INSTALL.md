# PAK Implementation: Auto-Generate Package Metadata for Agent Installation

## Background

Currently, agent packages (APKGs) cannot properly import root-level modules (like `core/`, `app/`) because they aren't installed as Python packages. This causes import errors like `ModuleNotFoundError: No module named 'core.langchain_util'`.

## Objective

Automatically generate a `setup.py` or `pyproject.toml` during APKG build so that PAR can install the agent itself as an editable Python package, making all agent code importable.

## Current State

### Existing Package Structure (vivid-commenter example)
```
vivid-commenter/
  src/
    main.py           # from core.langchain_util import ...
  core/               # Root-level package
    langchain_util.py
  app/                # Root-level package
    v1/
  agent.yaml
  requirements.txt
  .env
```

### Current Build Process
File: `/Users/syum/dev/pixell-agent-kit/pixell/core/builder.py`

The builder:
1. Validates agent.yaml
2. Copies files to temp directory (src/, agent.yaml, .env, core/, app/, etc.)
3. Creates .pixell/package.json metadata
4. Creates requirements.txt if needed
5. Creates dist/ layout for surfaces
6. Creates deploy.json
7. Zips everything into .apkg file

**Problem:** No package metadata generated, so Python can't import agent modules.

## Implementation Requirements

### 1. Auto-Generate setup.py During Build

**Location:** In `_copy_agent_files()` or new method `_create_package_metadata()`

**Logic:**
- Detect all root-level Python packages (directories with `__init__.py` or containing .py files)
- Generate `setup.py` that declares these as packages
- Include it in the build directory before creating APKG

**Pseudo-code:**
```python
def _create_package_metadata(self, build_dir: Path):
    """Generate setup.py for agent package installation."""

    # 1. Discover all packages at root level
    packages = self._discover_packages(build_dir)

    # 2. Generate setup.py content
    setup_content = self._generate_setup_py(packages)

    # 3. Write setup.py to build directory
    setup_path = build_dir / "setup.py"
    setup_path.write_text(setup_content)

    logger.info("Generated setup.py", packages=packages)
```

### 2. Package Discovery Algorithm

**Key considerations:**
- Find directories containing Python files (not just `__init__.py`)
- Exclude: `__pycache__`, `.pyc` files, hidden directories
- Include: `src`, `core`, `app`, any custom directories
- Handle nested packages (e.g., `app.v1`, `core.util`)

**Implementation:**
```python
def _discover_packages(self, build_dir: Path) -> list[str]:
    """Discover all Python packages in the build directory.

    Returns:
        List of package names (e.g., ['src', 'core', 'app', 'app.v1'])
    """
    packages = []

    # Walk through build directory
    for root, dirs, files in os.walk(build_dir):
        # Skip hidden directories and __pycache__
        dirs[:] = [d for d in dirs if not d.startswith('.') and d != '__pycache__']

        # Check if this directory contains Python files
        has_python = any(f.endswith('.py') for f in files)

        if has_python:
            # Calculate package name relative to build_dir
            rel_path = Path(root).relative_to(build_dir)
            package_name = str(rel_path).replace(os.sep, '.')

            # Skip if it's just build_dir itself
            if package_name != '.':
                packages.append(package_name)

    # Sort for consistency
    packages.sort()
    return packages
```

### 3. setup.py Template

**Generated file content:**
```python
#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.
"""

from setuptools import setup, find_packages

setup(
    name="{agent_name}",
    version="{version}",
    description="{description}",
    packages={packages_list},
    package_dir={{"": "."}},
    install_requires=[],  # Dependencies handled by requirements.txt
    python_requires=">=3.9",
    include_package_data=True,
)
```

**Template Variables:**
- `{agent_name}`: From `manifest.name`
- `{version}`: From `manifest.metadata.version`
- `{description}`: From `manifest.description`
- `{packages_list}`: Python list literal of discovered packages

**Example output:**
```python
setup(
    name="vivid-commenter",
    version="1.0.1",
    description="AI-powered Reddit commenter",
    packages=['src', 'core', 'core.util', 'app', 'app.v1'],
    package_dir={"": "."},
    install_requires=[],
    python_requires=">=3.9",
    include_package_data=True,
)
```

### 4. Integration into Builder

**File:** `/Users/syum/dev/pixell-agent-kit/pixell/core/builder.py`

**Changes needed:**

1. Add new method after `_create_requirements()`:
```python
def _create_package_metadata(self, build_dir: Path):
    """Generate setup.py for agent package installation."""
    # Implementation here
```

2. Add new method for discovery:
```python
def _discover_packages(self, build_dir: Path) -> list[str]:
    """Discover all Python packages in the build directory."""
    # Implementation here
```

3. Add new method for template generation:
```python
def _generate_setup_py(self, packages: list[str]) -> str:
    """Generate setup.py content from template."""
    # Implementation here
```

4. Call it in `build()` method:
```python
def build(self, output_dir: Optional[Path] = None) -> Path:
    # ... existing code ...

    # Create requirements.txt if needed
    self._create_requirements(temp_path)

    # NEW: Create setup.py for package installation
    self._create_package_metadata(temp_path)

    # Create dist/ layout for surfaces
    self._create_dist_layout(temp_path)

    # ... rest of build ...
```

## Edge Cases to Handle

### Case 1: Agent Already Has setup.py
**Behavior:** Don't overwrite it
```python
if (build_dir / "setup.py").exists():
    logger.info("Agent already has setup.py, skipping generation")
    return
```

### Case 2: No Python Packages Found
**Behavior:** Generate minimal setup.py with just `src`
```python
if not packages:
    packages = ['src']  # Fallback to src directory
    logger.warning("No packages discovered, defaulting to 'src'")
```

### Case 3: Namespace Packages (No __init__.py)
**Behavior:** Use `find_packages()` helper or explicit list

**Decision:** Use explicit package list from discovery algorithm (more reliable)

### Case 4: Agent Uses pyproject.toml Instead
**Future enhancement:** Support generating `pyproject.toml` format
**Current:** Generate `setup.py` (universal compatibility)

## Testing Requirements

### Unit Tests
File: `tests/test_builder.py` or new `tests/test_package_metadata.py`

**Test cases:**
1. `test_discover_packages_basic` - Simple structure (src/, core/, app/)
2. `test_discover_packages_nested` - Nested packages (app.v1.reddit)
3. `test_discover_packages_no_init` - Packages without __init__.py
4. `test_generate_setup_py` - Template generation correctness
5. `test_create_package_metadata` - Full integration
6. `test_skip_existing_setup` - Don't overwrite existing setup.py
7. `test_ignore_pycache` - Exclude __pycache__ directories

**Example test:**
```python
def test_discover_packages_basic(tmp_path):
    """Test discovering packages in basic agent structure."""
    # Create test structure
    (tmp_path / "src").mkdir()
    (tmp_path / "src" / "main.py").write_text("# main")
    (tmp_path / "core").mkdir()
    (tmp_path / "core" / "util.py").write_text("# util")

    builder = AgentBuilder(tmp_path)
    packages = builder._discover_packages(tmp_path)

    assert set(packages) == {'src', 'core'}
```

### Integration Tests
File: `tests/test_build_integration.py`

**Test case:**
1. Build real agent (vivid-commenter structure)
2. Extract APKG
3. Verify setup.py exists and is valid
4. Verify packages list is correct
5. Verify can install with `pip install -e .`

**Example:**
```python
def test_build_generates_setup_py(tmp_path):
    """Test that build generates valid setup.py."""
    # Create test agent
    agent_dir = create_test_agent(tmp_path, structure="vivid-commenter")

    # Build APKG
    builder = AgentBuilder(agent_dir)
    apkg_path = builder.build(tmp_path / "dist")

    # Extract and verify
    extract_dir = tmp_path / "extracted"
    extract_apkg(apkg_path, extract_dir)

    setup_path = extract_dir / "setup.py"
    assert setup_path.exists()

    # Verify it's valid Python
    exec(setup_path.read_text())  # Should not raise

    # Verify packages list
    content = setup_path.read_text()
    assert "'src'" in content
    assert "'core'" in content
    assert "'app'" in content
```

## Validation Requirements

### Pre-Build Validation
- Warn if no Python files found in any directory
- Warn if only .pyc files found (no source)

### Post-Build Validation
- Verify setup.py is valid Python syntax
- Verify all discovered packages exist in APKG
- Log package discovery results

### Build Output
```
Building agent from /path/to/vivid-commenter...
Copying src: /path/src -> /tmp/build/src
  Included: src/main.py
  Included: src/grpc_server.py
Copying core: /path/core -> /tmp/build/core
  Included: core/langchain_util.py
  Included: core/exceptions.py
Discovered packages: ['src', 'core', 'core.util', 'app', 'app.v1']
Generated setup.py for package installation

SUCCESS: Build successful!
  [Package] vivid-commenter-1.0.1.apkg
  [Location] /path/to/output
  [Size] 0.12 MB
  [Packages] src, core, core.util, app, app.v1
```

## Backward Compatibility

### For Agents Without Root Packages
**Example:** Simple agent with only `src/main.py`

**Behavior:**
- Discovery finds only `['src']`
- setup.py generated with `packages=['src']`
- Works exactly as before

### For Agents With Existing setup.py
**Behavior:** Skip generation, use existing setup.py

### For Old APKGs (No setup.py)
**Runtime behavior:** PAR will handle gracefully (see PAR implementation doc)

## Dependencies

**New imports needed:**
```python
import os  # For os.walk
from pathlib import Path  # Already imported
from typing import List  # For type hints
```

**No new external dependencies required.**

## Success Criteria

1. ✅ PAK auto-generates setup.py during build
2. ✅ All root-level Python packages discovered correctly
3. ✅ Generated setup.py is valid and installable
4. ✅ Doesn't break existing agents without root packages
5. ✅ Doesn't overwrite existing setup.py
6. ✅ Build output shows discovered packages
7. ✅ All tests pass

## Files to Modify

1. `/Users/syum/dev/pixell-agent-kit/pixell/core/builder.py`
   - Add `_discover_packages()` method
   - Add `_generate_setup_py()` method
   - Add `_create_package_metadata()` method
   - Call `_create_package_metadata()` in `build()`

2. `/Users/syum/dev/pixell-agent-kit/tests/test_builder.py`
   - Add unit tests for package discovery
   - Add unit tests for setup.py generation
   - Add integration tests

## Implementation Order

1. **Phase 1:** Implement `_discover_packages()` with tests
2. **Phase 2:** Implement `_generate_setup_py()` template
3. **Phase 3:** Implement `_create_package_metadata()` integration
4. **Phase 4:** Add to `build()` method
5. **Phase 5:** Integration testing with real agents
6. **Phase 6:** Update documentation

## Notes

- Keep setup.py template simple and robust
- Use explicit package list (not `find_packages()`) for reliability
- Log package discovery for debugging
- Consider adding to `.pixell/package.json` metadata for tracking
- Future: Could support `pyproject.toml` format as alternative

## Example Generated setup.py

For vivid-commenter agent:
```python
#!/usr/bin/env python3
"""
Auto-generated setup.py for agent package installation.
Generated by Pixell Agent Kit (PAK) during build.
"""

from setuptools import setup

setup(
    name="vivid-commenter",
    version="1.0.1",
    description="AI-powered Reddit commenter for marketing automation",
    packages=[
        'src',
        'core',
        'core.decorators',
        'core.model',
        'core.model.response',
        'core.type',
        'core.ui',
        'core.util',
        'app',
        'app.v1',
        'app.v1.reddit_commenter',
        'app.v1.reddit_commenter.service',
    ],
    package_dir={"": "."},
    install_requires=[],  # Dependencies handled by requirements.txt
    python_requires=">=3.9",
    include_package_data=True,
)
```
